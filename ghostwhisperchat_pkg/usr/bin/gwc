#!/bin/bash
# Launcher principal de GhostWhisperChat

export PYTHONPATH=$PYTHONPATH:/usr/lib

if [ "$1" == "--start" ]; then
    echo "Iniciando Demonio..."
    # Usamos exec para reemplazar el proceso shell por el demonio python
    # Esto evita que systemd mate el proceso al salir el script
    exec python3 -u -m ghostwhisperchat.demonio
fi

if [ "$1" == "--check" ]; then
    python3 -m ghostwhisperchat.core.diagnostico
    exit 0
fi

if [ "$1" == "--update" ] || [ "$1" == "update" ]; then
    echo "=========================================="
    echo "üîÑ AUTO-ACTUALIZADOR GHOSTWHISPERCHAT"
    echo "=========================================="
    
    REPO_PATH="$HOME/Escritorio/ghostwhisperchat-repo"
    
    if [ ! -d "$REPO_PATH" ]; then
        echo "[X] Error: No se encuentra el repositorio en $REPO_PATH"
        exit 1
    fi
    
    cd "$REPO_PATH" || exit 1
    
    echo "[*] Sincronizando c√≥digo (git pull)..."
    git pull || echo "[!] Advertencia: No se pudo hacer git pull (¬øConflictos o sin red?)"
    
    echo "[*] Generando paquete .deb..."
    ./actualizar_repo.sh
    
    echo "[*] Instalando actualizaci√≥n (Requiere sudo)..."
    # Re-escaneamos el repo local para APT (si est√° configurado en sources.list)
    # Si el usuario no tiene agregado el repo local a su sources.list, esto fallar√° con 'package not found' o instalar√° de internet (viejas).
    # MEJOR: Instalamos directamente el .deb generado para asegurar que es la √∫ltima versi√≥n local.
    
    # Buscamos el .deb m√°s reciente
    LATEST_DEB=$(ls -t pool/main/g/ghostwhisperchat/*.deb | head -n1)
    
    if [ -z "$LATEST_DEB" ]; then
        echo "[X] No se gener√≥ el .deb"
        exit 1
    fi
    
    sudo apt install "./$LATEST_DEB" -y
    
    echo "[*] Reiniciando demonio..."
    systemctl --user restart ghostwhisperchat
    
    echo "‚úÖ Actualizaci√≥n completada. Nueva versi√≥n:"
    gwc version
    exit 0
fi

# Default: Cliente
python3 -m ghostwhisperchat.cliente "$@"
